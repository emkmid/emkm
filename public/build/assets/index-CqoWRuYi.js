import{r,j as e,H as J}from"./app-BNBXPyAp.js";import{B as x}from"./button-CG4I0rhr.js";import{C as L,a as R,b as A,d as $}from"./card-lfiC7PRw.js";import{T as H,a as O,b as j,c as l,d as M,e as n}from"./table-BfUlpZM2.js";import{A as K}from"./app-layout-CrXQ-9n1.js";import"./index-CpNs-TYM.js";import"./index-BjsOvRp_.js";import"./createLucideIcon-GQdaFuD7.js";import"./index-BjWpYu-z.js";import"./index-C7Ys3ZSS.js";import"./calculator-BR8lv0Zp.js";async function P(u){const o=await fetch(u,{headers:{Accept:"application/json"},credentials:"same-origin"}),g=o.headers.get("content-type")||"";if(!o.ok){const m=await o.text();throw new Error(m||o.statusText||`HTTP ${o.status}`)}if(!g.includes("application/json")){const m=await o.text();throw new Error("Unexpected content-type: "+g+" — "+(m?m.slice(0,200):""))}return o.json()}function re(){const[u,o]=r.useState([]),[g,m]=r.useState([]),[d,y]=r.useState(1),[v,q]=r.useState(25),[p,F]=r.useState(""),[c,C]=r.useState(null),[b,U]=r.useState(1),[S,T]=r.useState(!1),[Q,_]=r.useState(!1),[B,f]=r.useState(!1),[k,h]=r.useState(null),[G,D]=r.useState([]),w=(s,t="info")=>{const a=String(Date.now())+Math.random().toString(36).slice(2,8);D(i=>[...i,{id:a,type:t,message:s}]),setTimeout(()=>D(i=>i.filter(N=>N.id!==a)),4500)};r.useEffect(()=>{let s=!1;const t=new URLSearchParams;return t.set("page",String(d)),t.set("per_page",String(v)),p&&t.set("q",p),h(null),T(!0),P("/dashboard/admin/payments/list?"+t.toString()).then(a=>{var i;s||(o(a.data||a||[]),U(a.last_page||((i=a.meta)==null?void 0:i.last_page)||1))}).catch(a=>{s||(console.error("Failed to load notifications:",a),h(a.message||"Gagal memuat payment notifications"))}).finally(()=>{s||T(!1)}),_(!0),P("/dashboard/admin/subscriptions/list?"+t.toString()).then(a=>{s||m(a.data||a||[])}).catch(a=>{s||(console.error("Failed to load subscriptions:",a),h(i=>i?i+`
`+a.message:a.message),w(a.message||"Gagal memuat subscriptions","error"))}).finally(()=>{s||_(!1)}),()=>{s=!0}},[d,v,p]);const E=()=>y(1),I=async s=>{f(!0),h(null);try{const t=await P(`/dashboard/admin/payments/${s}`);C(t)}catch(t){console.error(t),h((t==null?void 0:t.message)||"Gagal memuat detail")}finally{f(!1)}},z=()=>{const s=new URLSearchParams;p&&s.set("q",p),window.location.href=`/dashboard/admin/payments/export?${s.toString()}`};return e.jsxs(K,{children:[e.jsx(J,{title:"Payments"}),e.jsxs("div",{className:"flex flex-col gap-6 p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h1",{className:"text-2xl font-bold",children:"Payments"})}),e.jsxs(L,{children:[e.jsx(R,{children:e.jsx(A,{children:"Payment Notifications"})}),e.jsxs($,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("input",{value:p,onChange:s=>F(s.target.value),placeholder:"search order/event/payload",className:"input"}),e.jsxs("select",{value:v,onChange:s=>{q(Number(s.target.value)),E()},className:"input",children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:25,children:"25"}),e.jsx("option",{value:50,children:"50"})]}),e.jsx(x,{onClick:()=>{E()},children:"Apply"}),e.jsx(x,{onClick:z,children:"Export CSV"})]}),k&&e.jsx("div",{className:"mb-2 p-2 bg-red-50 text-red-700 rounded",children:k}),e.jsx("div",{className:"overflow-auto",children:e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(j,{children:[e.jsx(l,{children:"ID"}),e.jsx(l,{children:"Provider"}),e.jsx(l,{children:"Order ID"}),e.jsx(l,{children:"Event ID"}),e.jsx(l,{children:"Processed At"}),e.jsx(l,{children:"Payload"})]})}),e.jsx(M,{children:S?e.jsx(j,{children:e.jsx(n,{colSpan:6,className:"py-4 text-center",children:"Loading notifications…"})}):u.length===0?e.jsx(j,{children:e.jsx(n,{colSpan:6,className:"py-4 text-center",children:"No notifications"})}):u.map(s=>e.jsxs(j,{className:"hover:bg-gray-50",children:[e.jsx(n,{children:s.id}),e.jsx(n,{children:s.provider}),e.jsx(n,{children:s.order_id}),e.jsx(n,{children:s.provider_event_id}),e.jsx(n,{children:s.processed_at??"—"}),e.jsx(n,{children:e.jsx(x,{onClick:()=>I(s.id),disabled:B,children:"Details"})})]},s.id))})]})}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx(x,{onClick:()=>y(Math.max(1,d-1)),disabled:d<=1||S,children:"Prev"}),e.jsxs("div",{children:["Page ",d," / ",b]}),e.jsx(x,{onClick:()=>y(Math.min(b,d+1)),disabled:d>=b||S,children:"Next"})]})]})]}),e.jsxs(L,{children:[e.jsx(R,{children:e.jsx(A,{children:"Subscriptions"})}),e.jsx($,{children:e.jsx("div",{className:"overflow-auto",children:e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(j,{children:[e.jsx(l,{children:"ID"}),e.jsx(l,{children:"User"}),e.jsx(l,{children:"Package"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Order ID"}),e.jsx(l,{children:"Transaction ID"}),e.jsx(l,{children:"Period"})]})}),e.jsx(M,{children:g.map(s=>{var t,a,i;return e.jsxs(j,{children:[e.jsx(n,{children:s.id}),e.jsx(n,{children:((t=s.user)==null?void 0:t.name)??((a=s.user)==null?void 0:a.email)??"—"}),e.jsx(n,{children:((i=s.package)==null?void 0:i.name)??"—"}),e.jsx(n,{children:s.status}),e.jsx(n,{children:s.midtrans_order_id??"—"}),e.jsx(n,{children:s.midtrans_transaction_id??"—"}),e.jsx(n,{children:s.starts_at?`${s.starts_at} → ${s.ends_at}`:"—"})]},s.id)})})]})})})]}),c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white p-4 rounded shadow-lg w-3/4 max-h-[80vh] overflow-auto",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["Notification ",c.id]}),e.jsxs("div",{className:"mt-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Provider:"})," ",c.provider]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Order ID:"})," ",c.order_id]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Event ID:"})," ",c.provider_event_id]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Processed At:"})," ",c.processed_at??"—"]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("strong",{children:"Payload:"}),e.jsx("pre",{className:"text-xs overflow-auto",children:JSON.stringify(c.payload,null,2)})]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx(x,{variant:"ghost",onClick:()=>C(null),children:"Close"}),e.jsx(x,{onClick:async()=>{var s;if(c&&confirm("Replay this notification and reprocess?")){f(!0),h(null);try{const t=((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||"",a=await fetch(`/dashboard/admin/payments/${c.id}/replay`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-CSRF-TOKEN":t},credentials:"same-origin"});if(!a.ok){const N=await a.text();throw new Error(N||a.statusText)}const i=await a.json();await I(c.id),w(i.message?String(i.message):"Replay succeeded","success")}catch(t){console.error(t),h((t==null?void 0:t.message)||"Replay failed"),w((t==null?void 0:t.message)||"Replay failed","error")}finally{f(!1)}}},children:"Replay"})]})]})}),e.jsx("div",{className:"fixed right-4 top-16 z-50 flex flex-col gap-2",children:G.map(s=>e.jsx("div",{className:`max-w-xs px-4 py-2 rounded shadow-lg text-sm ${s.type==="success"?"bg-green-600 text-white":s.type==="error"?"bg-red-600 text-white":"bg-gray-800 text-white"}`,children:s.message},s.id))})]})]})}export{re as default};
