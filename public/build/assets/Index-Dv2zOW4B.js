import{u as L,r as u,a as m,j as a,H as F}from"./app-Buu2DikG.js";import{A as R}from"./app-layout-BFNV6KpS.js";import"./button-C7rOBH6R.js";import"./index-BkLU9fTm.js";import"./index-CuerXDul.js";import"./createLucideIcon-BSWIeYhp.js";import"./index-C1HTGlpo.js";import"./index-D-1d1gY5.js";import"./calculator-CIv7IznV.js";function q({packages:w,userSubscription:c,pendingPayment:l,checkoutData:b}){var N;const{flash:i,errors:g}=L().props,[p,d]=u.useState(null),[x,S]=u.useState({}),[f,n]=u.useState(""),[A,j]=u.useState(!!l);u.useEffect(()=>{b&&(console.log("=== CHECKOUT DATA FROM PROPS ==="),console.log("CheckoutData received:",b),y(b))},[b]),u.useEffect(()=>{if(console.log("=== FLASH DATA CHECK ==="),console.log("Flash object:",i),console.log("Flash keys:",Object.keys(i||{})),console.log("Flash.checkoutData:",i==null?void 0:i.checkoutData),console.log("All flash values:",JSON.stringify(i,null,2)),i!=null&&i.checkoutData)console.log("Processing checkout data from flash..."),y(i.checkoutData);else{console.log("No checkout data in flash");for(const[e,t]of Object.entries(i||{}))if(typeof t=="object"&&t!==null&&"snap_token"in t){console.log(`Found potential checkoutData in flash.${e}:`,t),y(t);return}}},[i]),u.useEffect(()=>{g!=null&&g.subscription&&n(g.subscription)},[g]);const v=[{value:"1_month",label:"1 Bulan"},{value:"3_months",label:"3 Bulan",discount:5},{value:"6_months",label:"6 Bulan",discount:10},{value:"1_year",label:"1 Tahun",discount:15}],_=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e),C=(e,t)=>{const s=e.price,o={"1_month":1,"3_months":3,"6_months":6,"1_year":12},r={"1_month":1,"3_months":.95,"6_months":.9,"1_year":.85},h=o[t]||1,I=r[t]||1,T=e.discount_percentage?e.discount_percentage/100:0,D=I-T;return s*h*D},k=async e=>(console.log("=== LOADING MIDTRANS SNAP ==="),console.log("Client key:",e.client_key),console.log("Is production:",e.is_production),new Promise((t,s)=>{const o=document.getElementById("midtrans-script");o&&(console.log("Removing existing Midtrans script"),o.remove());const r=document.createElement("script");r.id="midtrans-script",r.src=e.is_production?"https://app.midtrans.com/snap/snap.js":"https://app.sandbox.midtrans.com/snap/snap.js",r.setAttribute("data-client-key",e.client_key),console.log("Script URL:",r.src),console.log("Client key attribute:",e.client_key),r.onload=()=>{console.log("Midtrans script loaded successfully"),console.log("Window.snap available:",!!window.snap),t()},r.onerror=h=>{console.error("Failed to load Midtrans script:",h),s(new Error("Failed to load Midtrans Snap script"))},document.head.appendChild(r),console.log("Midtrans script added to document head")})),P=async e=>{const t=x[e.id]||"1_month";d(e.id.toString()),n("");try{if(e.price===0){m.post("/subscriptions/activate-free",{package_id:e.id},{preserveState:!0,preserveScroll:!0,onSuccess:()=>{console.log("Free package activated successfully")},onError:s=>{console.error("Free package activation error:",s),s.error_code==="ACTIVE_SUBSCRIPTION_EXISTS"?n("Anda sudah memiliki subscription aktif."):n(s.message||"Gagal mengaktivasi package gratis.")},onFinish:()=>{d(null)}});return}if(!e.duration_options||!e.duration_options.includes(t))throw new Error(`Duration tidak tersedia untuk paket ini. Available: ${JSON.stringify(e.duration_options)}`);console.log("Starting subscription for package:",e.name,"duration:",t),console.log("Package price:",e.price),console.log("Package is active:",e.is_active),m.post("/subscriptions/checkout",{package_id:e.id,duration:t},{preserveState:!1,preserveScroll:!0,onSuccess:()=>{console.log("Subscription request successful - waiting for page reload with checkoutData")},onError:s=>{var o,r;if(console.error("Checkout error:",s),s.error_code)switch(s.error_code){case"ACTIVE_SUBSCRIPTION_EXISTS":n(`Anda sudah memiliki subscription aktif (${((r=(o=s.data)==null?void 0:o.current_subscription)==null?void 0:r.package_name)||"Unknown"})`);break;case"RECENT_PENDING_PAYMENT":n("Anda memiliki pembayaran yang sedang diproses. Silakan tunggu beberapa menit.");break;case"PACKAGE_INACTIVE":n("Paket ini sedang tidak tersedia.");break;case"INVALID_DURATION":n("Durasi yang dipilih tidak tersedia untuk paket ini.");break;case"VALIDATION_ERROR":const h=Object.values(s.errors||{}).flat();n(`Data tidak valid: ${h.join(", ")}`);break;default:n(s.message||"Gagal membuat pembayaran")}else s.message?n(s.message):n(typeof s=="string"?s:"Terjadi kesalahan saat memproses pembayaran.")},onFinish:()=>{console.log("Request finished"),d("")}})}catch(s){console.error("Error in handleSubscribe:",s),n(s.message||"Terjadi kesalahan saat memproses pembayaran"),d("")}},y=async e=>{console.log("=== MIDTRANS DEBUG ==="),console.log("Checkout data received:",e),console.log("Snap token:",e.snap_token),console.log("Client key:",e.client_key),console.log("Is production:",e.is_production);try{if(console.log("Loading Midtrans Snap script..."),await k(e),console.log("Midtrans Snap script loaded successfully"),!window.snap)throw new Error("Midtrans Snap not available on window object");console.log("Calling snap.pay with token:",e.snap_token),window.snap.pay(e.snap_token,{onSuccess:t=>{console.log("Payment success:",t),m.visit("/subscriptions/success",{data:{transaction_id:t.order_id}})},onPending:t=>{console.log("Payment pending:",t),m.visit("/subscriptions/pending",{data:{transaction_id:t.order_id}})},onError:t=>{console.log("Payment error:",t),t.status_code==="409"?n("Token pembayaran sudah expired. Silakan coba lagi."):n(`Pembayaran gagal: ${t.error_message||"Unknown error"}`)},onClose:()=>{console.log("Payment modal closed"),d(null)}})}catch(t){console.error("Midtrans checkout error:",t),n("Gagal memuat halaman pembayaran")}},E=async()=>{if(!(l!=null&&l.snap_token)){n("Snap token tidak tersedia untuk melanjutkan pembayaran");return}d("continue-payment");try{await k({snap_token:l.snap_token,client_key:"your-client-key",is_production:!1}),window.snap.pay(l.snap_token,{onSuccess:e=>{console.log("Payment success:",e),m.visit("/subscriptions/success",{data:{transaction_id:e.order_id}})},onPending:e=>{console.log("Payment pending:",e),m.visit("/subscriptions/pending",{data:{transaction_id:e.order_id}})},onError:e=>{console.log("Payment error:",e),m.visit("/subscriptions/error",{data:{message:"Pembayaran gagal"}})},onClose:()=>{console.log("Payment modal closed"),j(!0)}})}catch(e){console.error("Continue payment error:",e),n("Gagal melanjutkan pembayaran")}finally{d(null)}},M=()=>{l&&(d("cancel-payment"),m.post("/subscriptions/cancel-pending",{subscription_id:l.subscription_id},{onSuccess:()=>{j(!1),n("")},onError:e=>{n("Gagal membatalkan pembayaran")},onFinish:()=>{d(null)}}))};return c&&(e=>["active","trialing"].includes(e))(c.status),a.jsxs(R,{children:[a.jsx(F,{title:"Paket Berlangganan"}),a.jsx("script",{src:"https://app.sandbox.midtrans.com/snap/snap.js","data-client-key":""}),A&&l&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:a.jsx("div",{className:"bg-white rounded-lg p-6 max-w-md w-full mx-4",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4",children:a.jsx("svg",{className:"h-6 w-6 text-yellow-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})})}),a.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Pembayaran Tertunda"}),a.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Anda memiliki pembayaran yang belum selesai untuk paket ",a.jsx("strong",{children:l.package_name})," senilai ",a.jsx("strong",{children:_(l.amount)}),"."]}),a.jsxs("div",{className:"flex space-x-3",children:[a.jsx("button",{onClick:E,disabled:p==="continue-payment",className:"flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50",children:p==="continue-payment"?"Memproses...":"Lanjutkan Pembayaran"}),a.jsx("button",{onClick:M,disabled:p==="cancel-payment",className:"flex-1 bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 disabled:opacity-50",children:p==="cancel-payment"?"Membatalkan...":"Batalkan"})]})]})})}),a.jsx("div",{className:"py-12",children:a.jsx("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:a.jsx("div",{className:"bg-white overflow-hidden shadow-sm sm:rounded-lg",children:a.jsxs("div",{className:"p-6",children:[a.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-8 text-center",children:"Pilih Paket Berlangganan"}),c&&c.status==="active"&&a.jsxs("div",{className:"mb-8 p-4 bg-green-100 border border-green-400 text-green-700 rounded",children:[a.jsx("p",{className:"font-medium",children:"Anda sudah memiliki subscription aktif"}),a.jsxs("p",{className:"text-sm",children:["Paket: ",(N=c.package)==null?void 0:N.name," | Berakhir: ",c.ends_at?new Date(c.ends_at).toLocaleDateString("id-ID"):"Tidak terbatas"]})]}),f&&a.jsx("div",{className:"mb-8 p-4 bg-red-100 border border-red-400 text-red-700 rounded",children:f}),a.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:w.map(e=>{var t;return a.jsxs("div",{className:`relative bg-white border-2 rounded-lg p-6 ${e.is_popular?"border-blue-500 shadow-lg transform scale-105":"border-gray-200"}`,children:[e.is_popular&&a.jsx("div",{className:"absolute -top-3 left-1/2 transform -translate-x-1/2",children:a.jsx("span",{className:"bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium",children:"Terpopuler"})}),a.jsxs("div",{className:"text-center",children:[a.jsx("h3",{className:"text-xl font-bold text-gray-900 mb-2",children:e.name}),a.jsx("p",{className:"text-gray-600 mb-4",children:e.description}),e.name!=="Free"&&a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Durasi"}),a.jsx("select",{value:x[e.id]||"1_month",onChange:s=>S({...x,[e.id]:s.target.value}),className:"w-full p-2 border border-gray-300 rounded-md",children:v.filter(s=>(e.duration_options||["1_month"]).includes(s.value)).map(s=>a.jsxs("option",{value:s.value,children:[s.label,s.discount&&` (Hemat ${s.discount}%)`]},s.value))})]}),a.jsx("div",{className:"mb-6",children:e.price===0?a.jsx("div",{className:"text-3xl font-bold text-gray-900",children:"GRATIS"}):a.jsxs("div",{children:[a.jsx("div",{className:"text-3xl font-bold text-gray-900",children:_(C(e,x[e.id]||"1_month"))}),a.jsxs("div",{className:"text-sm text-gray-500",children:["per ",(t=v.find(s=>s.value===(x[e.id]||"1_month")))==null?void 0:t.label]}),e.discount_percentage>0&&a.jsxs("div",{className:"text-sm text-green-600 font-medium",children:["Diskon ",e.discount_percentage,"%"]})]})}),a.jsx("ul",{className:"text-left mb-6 space-y-2",children:Object.entries(e.features).map(([s,o])=>a.jsxs("li",{className:`flex items-center ${o?"text-gray-900":"text-gray-400"}`,children:[a.jsx("svg",{className:`w-4 h-4 mr-2 ${o?"text-green-500":"text-gray-300"}`,fill:"currentColor",viewBox:"0 0 20 20",children:a.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),s==="products"&&"Manajemen Produk",s==="transactions"&&"Transaksi",s==="reports"&&"Laporan",s==="hpp"&&"Harga Pokok Penjualan",s==="priority_support"&&"Support Prioritas",s==="advanced_reports"&&"Laporan Lanjutan",s==="api_access"&&"Akses API",s==="white_label"&&"White Label",s==="custom_integration"&&"Integrasi Custom",typeof o=="string"&&`${s}: ${o}`,typeof o=="number"&&`${s}: ${o}`]},s))}),a.jsx("button",{onClick:()=>P(e),disabled:p===e.id.toString()||(c==null?void 0:c.status)==="active"&&e.name!=="Free",className:`w-full py-2 px-4 rounded-md font-medium ${e.is_popular?"bg-blue-600 hover:bg-blue-700 text-white":"bg-gray-800 hover:bg-gray-900 text-white"} disabled:opacity-50 disabled:cursor-not-allowed`,children:p===e.id.toString()?a.jsxs("div",{className:"flex items-center justify-center",children:[a.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[a.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),a.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Memproses..."]}):e.name==="Free"?"Gunakan Gratis":"Berlangganan"})]})]},e.id)})}),a.jsxs("div",{className:"mt-12 text-center",children:[a.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Mengapa Berlangganan?"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 text-left",children:[a.jsxs("div",{className:"p-4",children:[a.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Fitur Lengkap"}),a.jsx("p",{className:"text-gray-600 text-sm",children:"Akses ke semua fitur akuntansi dan manajemen bisnis yang Anda butuhkan."})]}),a.jsxs("div",{className:"p-4",children:[a.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Support 24/7"}),a.jsx("p",{className:"text-gray-600 text-sm",children:"Tim support siap membantu Anda kapan saja untuk menyelesaikan masalah."})]}),a.jsxs("div",{className:"p-4",children:[a.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Update Berkala"}),a.jsx("p",{className:"text-gray-600 text-sm",children:"Dapatkan fitur-fitur baru dan perbaikan bug secara otomatis."})]})]})]})]})})})})]})}export{q as default};
